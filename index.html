<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cyberpunk Collection</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --neon: #00f2ff; --text: #c9d1d9; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; padding-bottom: 220px; }
        header { text-align: center; padding: 20px 0; }
        .main-title { font-family: 'Orbitron', sans-serif; font-size: 1.4rem; color: var(--neon); letter-spacing: 3px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.4); }
        .playlist { max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
        .track-item { display: flex; align-items: center; background: var(--card); border-radius: 12px; padding: 10px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .track-img { width: 55px; height: 55px; border-radius: 8px; object-fit: cover; margin-right: 15px; background: #222; }
        .track-info { flex-grow: 1; overflow: hidden; }
        .track-name { font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .like-box { text-align: center; min-width: 45px; }
        .like-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; color: #30363d; transition: 0.3s; }
        .like-btn.active { color: #f85149; transform: scale(1.2); }
        .like-count { font-size: 0.7rem; color: #8b949e; display: block; }
        .player-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: rgba(22, 27, 34, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); z-index: 9999; }
        #now-playing { font-size: 0.8rem; text-align: center; margin-bottom: 8px; color: var(--neon); }
        .progress-bg { width: 100%; height: 4px; background: #30363d; border-radius: 2px; cursor: pointer; margin-bottom: 10px; }
        #progress-bar { width: 0%; height: 100%; background: var(--neon); }
        .controls { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .c-btn { background: none; border: none; cursor: pointer; fill: #fff; }
        .play-btn { background: var(--neon); border-radius: 50%; width: 45px; height: 45px; fill: #000 !important; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<header><div class="main-title">EVGEN MUSIC DB</div></header>
<div id="playlist" class="playlist">Загрузка системы...</div>

<div class="player-bar">
    <div id="now-playing">STANDBY</div>
    <div class="progress-bg" onclick="seek(event)"><div id="progress-bar"></div></div>
    <div class="controls">
        <button class="c-btn" onclick="prev()"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6L18 18V6z"/></svg></button>
        <button class="c-btn play-btn" onclick="toggle()"><svg width="24" height="24" viewBox="0 0 24 24"><path id="pIcon" d="M8 5v14l11-7z"/></svg></button>
        <button class="c-btn" onclick="next()"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
    </div>
</div>

<audio id="player"></audio>

<script>
    // ТВОИ ДАННЫЕ (УЖЕ ВСТАВИЛ)
    const SUPA_URL = "https://ojxyjiawdprejvmbsvvj.supabase.co";
    const SUPA_KEY = "Sb_publishable_CCjT5fIUcKY-jzlZyzKwLQ_eLfaT1ks"; // Используем твой publishable
    const supabase = typeof supabase !== 'undefined' ? supabase.createClient(SUPA_URL, SUPA_KEY) : null;

    const CFG = { u: 'evgensmoke', r: 'Mymusic', def: 'https://raw.githubusercontent.com/evgensmoke/Mymusic/main/default.jpg' };
    let tracks = [], cur = -1;
    const audio = document.getElementById('player');

    async function init() {
        try {
            const res = await fetch(`https://api.github.com/repos/${CFG.u}/${CFG.r}/contents/`);
            const data = await res.json();
            const mp3s = data.filter(f => f.name.toLowerCase().endsWith('.mp3'));
            
            tracks = mp3s.map(f => ({
                id: f.name.replace(/\.[^/.]+$/, ""),
                url: `https://raw.githubusercontent.com/${CFG.u}/${CFG.r}/main/${encodeURIComponent(f.name)}`,
                img: CFG.def
            }));
            
            await render();
            loadAllLikes(); // Тянем лайки из базы
        } catch(e) { document.getElementById('playlist').innerHTML = "Ошибка связи."; }
    }

    async function render() {
        document.getElementById('playlist').innerHTML = tracks.map((t, i) => `
            <div class="track-item" onclick="playT(${i})">
                <img src="${t.img}" class="track-img" id="img-${i}">
                <div class="track-info"><div class="track-name" id="title-${i}">${t.id}</div></div>
                <div class="like-box">
                    <button class="like-btn" id="l-${i}" onclick="event.stopPropagation(); vote('${t.id}', ${i})">❤️</button>
                    <span class="like-count" id="c-${i}">0</span>
                </div>
            </div>
        `).join('');
        tracks.forEach((t, i) => readTags(t, i));
    }

    function readTags(track, i) {
        jsmediatags.read(track.url, {
            onSuccess: (tag) => {
                if (tag.tags.picture) {
                    const { data, format } = tag.tags.picture;
                    const base64 = btoa(data.map(b => String.fromCharCode(b)).join(""));
                    document.getElementById(`img-${i}`).src = `data:${format};base64,${base64}`;
                }
                if (tag.tags.title) document.getElementById(`title-${i}`).innerText = tag.tags.title;
            }
        });
    }

    // --- РАБОТА С ЛАЙКАМИ (SUPABASE) ---
    async function loadAllLikes() {
        const { data } = await supabase.from('likes').select('*');
        if (data) {
            data.forEach(row => {
                const idx = tracks.findIndex(t => t.id === row.song_id);
                if (idx !== -1) document.getElementById(`c-${idx}`).innerText = row.count;
            });
        }
    }

    async function vote(id, i) {
        const countEl = document.getElementById(`c-${i}`);
        const btn = document.getElementById(`l-${i}`);
        let currentCount = parseInt(countEl.innerText);

        btn.classList.toggle('active');
        const isLike = btn.classList.contains('active');
        const newCount = isLike ? currentCount + 1 : Math.max(0, currentCount - 1);
        countEl.innerText = newCount;

        // Магия Supabase: upsert (обновить или создать)
        await supabase.from('likes').upsert({ song_id: id, count: newCount }, { onConflict: 'song_id' });
    }

    function playT(i) {
        cur = i; audio.src = tracks[i].url; audio.play();
        document.getElementById('now-playing').innerText = document.getElementById(`title-${i}`).innerText;
        document.getElementById('pIcon').setAttribute('d', "M6 19h4V5H6v14zm8-14v14h4V5h-4z");
    }

    function toggle() {
        if(cur === -1) return playT(0);
        if(audio.paused) { audio.play(); document.getElementById('pIcon').setAttribute('d', "M6 19h4V5H6v14zm8-14v14h4V5h-4z"); }
        else { audio.pause(); document.getElementById('pIcon').setAttribute('d', "M8 5v14l11-7z"); }
    }

    function next() { cur = (cur + 1) % tracks.length; playT(cur); }
    function prev() { cur = (cur - 1 + tracks.length) % tracks.length; playT(cur); }
    audio.ontimeupdate = () => { document.getElementById('progress-bar').style.width = (audio.currentTime / audio.duration) * 100 + '%'; };
    init();
</script>
</body>
</html>

